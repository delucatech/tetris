<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AR Tetris on Oculus Quest 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: black; }
    #debug-panel { position: absolute; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.8); padding: 10px; z-index: 1000; }
    #status-indicator { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 5px; font-weight: bold; z-index: 1000; background-color: red; color: white; }
  </style>
</head>
<body>

<div id="status-indicator">INITIALIZING...</div>
<div id="debug-panel">Debug log initialized...</div>
<button id="start-btn" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: green; color: white; font-size: 18px;">Start Game (Non-AR)</button>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
  import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

  let scene, camera, renderer, controls;
  let boardGroup, activePieceGroup;
  let gameStarted = false;
  let boardPlaced = false;
  let hitTestSource = null;
  let localSpace = null;
  let reticle = null;

  function log(message) {
    console.log(message);
    document.getElementById('debug-panel').textContent += '\n' + message;
  }

  function setStatus(status) {
    document.getElementById('status-indicator').textContent = status;
  }

  function initThreeJS() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setClearColor(0x000000, 1);
    renderer.xr.enabled = true;

    document.body.appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0, -1);
    controls.update();

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(1, 2, 3);
    scene.add(light);

    boardGroup = new THREE.Group();
    scene.add(boardGroup);

    activePieceGroup = new THREE.Group();
    scene.add(activePieceGroup);

    const geometry = new THREE.PlaneGeometry(1, 1);
    const material = new THREE.MeshBasicMaterial({ color: 0x555555, side: THREE.DoubleSide });
    const ground = new THREE.Mesh(geometry, material);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -0.01;
    boardGroup.add(ground);

    const reticleGeometry = new THREE.RingGeometry(0.05, 0.06, 32);
    reticleGeometry.rotateX(-Math.PI / 2);
    const reticleMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.8 });
    reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    setStatus("Three.js Initialized");
  }

  function addARButton() {
    document.body.appendChild(ARButton.createButton(renderer, {
      requiredFeatures: ['hit-test'],
      optionalFeatures: ['dom-overlay'],
      domOverlay: { root: document.body }
    }));
  }

  function startGame() {
    if (gameStarted) return;
    gameStarted = true;
    setStatus("Game Started");
    document.getElementById('start-btn').style.display = "none";

    const cubeGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
    const cubeMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
    const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
    cube.position.set(0, 0.2, -1);
    scene.add(cube);

    renderer.setAnimationLoop(animate);
  }

  function setupXR() {
    renderer.xr.addEventListener('sessionstart', async () => {
      setStatus("XR Session Started");
      const session = renderer.xr.getSession();
      const viewerSpace = await session.requestReferenceSpace('viewer');
      hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
      localSpace = await session.requestReferenceSpace('local');

      session.addEventListener('select', () => {
        if (!boardPlaced) {
          const matrix = new THREE.Matrix4();
          matrix.fromArray(reticle.matrix.elements);
          const position = new THREE.Vector3();
          position.setFromMatrixPosition(matrix);
          boardGroup.position.copy(position);
          boardPlaced = true;
          setStatus("Board Placed");
          startGame();
        }
      });
    });

    renderer.xr.addEventListener('sessionend', () => {
      setStatus("XR Session Ended");
      hitTestSource = null;
      localSpace = null;
    });
  }

  function animate(timestamp, frame) {
    if (frame) {
      const session = renderer.xr.getSession();
      if (hitTestSource && !boardPlaced) {
        const hitTestResults = frame.getHitTestResults(hitTestSource);
        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const hitPose = hit.getPose(localSpace);
          reticle.visible = true;
          reticle.matrix.fromArray(hitPose.transform.matrix);
        } else {
          reticle.visible = false;
        }
      }
    }

    renderer.render(scene, camera);
  }

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  document.getElementById('start-btn').addEventListener('click', () => {
    startGame();
  });

  initThreeJS();
  
  if ('xr' in navigator) {
    navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
      if (supported) {
        setStatus("XR Available - Tap AR Button");
        addARButton();
        setupXR();
      } else {
        setStatus("No AR - Playing in Normal Mode");
      }
    }).catch(() => {
      setStatus("XR Error - Normal Mode");
    });
  } else {
    setStatus("No WebXR Support - Normal Mode");
  }

</script>
</body>
</html>
